<?php

function github_deploy_menu(){
      $items = array();

      $items['admin/settings/mc_deploy'] = array(
        'title' => 'github deploy',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('mc_deploy_form_settings'),
        'access arguments' => array('administer mc_deploy'),
        'type' => MENU_CALLBACK
      );

      $items['github/deploy'] = array(
        'title' => 'github deploy',
        'page callback' => '_github_deploy',
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK
      );

    return $items;
}

function github_deploy_perm() {
  return array('administer mc_deploy');
}

function exec_enabled() {
    $disabled = explode(', ', ini_get('disable_functions'));
    return !in_array('exec', $disabled);
}

function mc_deploy_form_settings(){
  $form = array();

  $form['mc_deploy_ssh_host'] = array(
    '#type' => 'textfield',
    '#title' => t('SSH Host'),
    '#default_value' => variable_get("mc_deploy_ssh_host","")
  );

  $form['mc_deploy_shh_user'] = array(
          '#type' => 'textfield',
          '#title' => t('SSH User Name'),
          '#default_value' => variable_get("mc_deploy_shh_user","")
  );

  $form['mc_deploy_ssh_pass'] = array(
           '#type' => 'textfield',
           '#title' => t('SSH Password'),
           '#default_value' => variable_get("mc_deploy_ssh_pass","")
  );

  return system_settings_form($form);
}

function _github_deploy(){

    $sitepath = realpath('.');
    $dsite = $sitepath ."/".conf_path();

    include_once(libraries_get_path('phpseclib') .'/' . 'Math/BigInteger.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Crypt/Random.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Crypt/Hash.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Crypt/TripleDES.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Crypt/RC4.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Crypt/AES.php');
    include_once(libraries_get_path('phpseclib') .'/' . 'Net/SSH2.php');

    set_time_limit(120);

    $ssh = new Net_SSH2('localhost');
    if (!$ssh->login('quickstart', 'quickstart')) {
       exit('Login Failed');
    }

    $output[] = $ssh->exec("ls");
    $output[] = $ssh->exec("cd /");
    $output[] = $ssh->exec("ls");
    $output[] = $ssh->exec("sh deploy.sh mt");


    //$sitepath = "/home/www/miamitech/dev.miamitech.org/htdocs";

    return 'Done Executing deploy script';
}