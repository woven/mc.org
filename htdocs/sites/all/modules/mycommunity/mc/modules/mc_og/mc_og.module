<?php

require_once ( dirname(__FILE__) . '/mc_og.inc');

function mc_og_form_alter(&$form, &$form_state, $form_id) {
  // Add audience selection to node forms
  if (isset($form['#node']) && $form_id == $form['#node']->type .'_node_form') {
    $node = $form['#node'];
    if (og_is_group_post_type($node->type)) {
      _mc_og_form_add_og_audience($form, $form_state);
    }
  }
}

function og_post_visibility($node){
  $is_public = $node->og_public;

  if(!empty($node->og_access_roles)){
    $is_auth = array_search('2',$node->og_access_roles);
  }else{
    $is_auth = false;
  }

  if(!($is_auth === false)){
    $is_auth = 1;
  }else{
    $is_auth = 0;
  }

  if($is_public){
    return 0;
  }else{
    if($is_auth){
      return 2;
    }
    return 1;
  }

}

function mc_og_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
  global $user;
  if (!og_is_group_post_type($node->type)) {
    return;
  }

  switch($op){
    case 'load':
      $node->og_post_visibility = og_post_visibility($node);
      break;
  }

}


function _mc_og_post_visibility_validate($form, &$form_state) {
  $form_post_visibility = $form_state['values']['og_post_visibility'];
  $og = &$form['og_nodeapi'];

  switch($form_post_visibility){
    case 0; //public
      form_set_value($og['visible']['og_public'], 1, $form_state);
      form_set_value($og['og_access_roles'], array(), $form_state);
    break;
    case 1; //private
      form_set_value($og['visible']['og_public'], 0, $form_state);
      form_set_value($og['og_access_roles'], array(), $form_state);
    break;
    case 2; //semi-private
      form_set_value($og['visible']['og_public'], 0, $form_state);
      form_set_value($og['og_access_roles'], array(2), $form_state);
    break;
  }
}

function mc_og_late_form_alter(&$form, &$form_state, $form_id) {

  if (isset($form['#node']) && $form_id == $form['#node']->type .'_node_form' && og_is_group_post_type($form['#node']->type)) {
    $og = &$form['og_nodeapi'];
    $og_visible = &$og['visible'];

    $og_groups = $og_visible['og_groups'];

    if(!(isset($og_groups['#options']) && !empty($og_groups['#options']))){
      $l = l("browse available groups","groups");
      drupal_set_message("Woops, you must be a member of a group first. Please $l.");
      drupal_goto('<front>');
    }

  }

  //post visibility
  if (isset($form['#node']) && $form_id == $form['#node']->type .'_node_form' && og_is_group_post_type($form['#node']->type)) {

    $node = $form['#node'];

    array_unshift($form['#validate'],'_mc_og_post_visibility_validate');

    $og = &$form['og_nodeapi'];
    $og_visible = &$og['visible'];

    $og_visible['og_post_visibility'] = array(
        '#type' => 'radios',
        '#title' => t('Post Visibility'),
        '#options' => array(
          '0' => 'Public',
          '1' => 'Private',
          '2' => 'Semi-Private'
        ),
        '#default_value' => ($node->og_post_visibility) ? $node->og_post_visibility : 0
    );

    $og_visible['og_public']['#prefix'] = '<div style="display:none;">';
    $og_visible['og_public']['#suffix'] = '</div>';


    $og['og_access_roles']['#prefix'] = '<div style="display:none;">';
    $og['og_access_roles']['#suffix'] = '</div>';

    //force discussions forms to be always public
    if($node->type == "forum"){
      unset($og_visible['og_post_visibility']);
      $og_visible['og_public']['#default_value'] = 1;
    }
  }

}

function mc_og_perm(){
  return array('post to all the groups');
}