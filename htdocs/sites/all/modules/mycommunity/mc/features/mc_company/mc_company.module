<?php
/**
 * @file
 * Code for the Company feature.
 */

include_once 'mc_company.features.inc';

function mc_company_late_form_alter(&$form, &$form_state, $form_id){
    global $user;

    if(!is_ct_form($form,"company")){
        return; //exit if not company node.
    }

    //remove some fields from non admin users
    if($user->uid > 1){
        $form['#after_build'][] = 'mc_company_node_form_after_build';
        unset($form['og_selective']);
        unset($form['og_register']);
        unset($form['og_directory']);
        unset($form['og_menu']);
        unset($form['og_private']);
    }

}

function mc_company_node_form_after_build($form, &$form_state){

    $form['body_field']['format']['#access'] = false;
    //modify some files default values
    $form['field_industry']['value']['#options'][''] = "Choose...";
    $form['field_company_size']['value']['#options'][''] = "Choose...";

    unset($form['field_ishiring']['value']['']);
    unset($form['field_islookingfund']['value']['']);

    return $form;
}

function mc_company_preprocess($vars,$hook){
    if($hook == 'block'){
        $cblock = $vars['block'];
        if($cblock->module == 'ds' && $cblock->bid == 'ds-f75e0974f5723f830348fb4d9444931b'){
            $cblock->subject = t("Where it's at");
        }
        if($cblock->module == 'ds' && $cblock->bid == 'ds-3cc955558f2299879e4f9d02f84134bd'){
            $cblock->subject = t("Get in touch");
        }
    }
}

function mc_company_menu(){

    $items['directory'] = array(
        'title' => 'Directory',
        'description' => 'Directory page',
        'access arguments' => array('access content'),
        'page callback' => 'directory_page',
    );

    $items['directory/%'] = array(
        'title' => 'Directory',
        'description' => 'Directory page',
        'access arguments' => array('access content'),
        'page callback' => 'directory_page_sub',
        'page arguments' => array(1)
    );

    return $items;
}

function _directory_active_view(){
    $view = arg(1);
    $allowed = array('list','map');

    //check if it's valid view
    if(isset($view) && !empty($view) && in_array($view,$allowed)){
        return $view;
    }else{
        //return default value
        return 'list';
    }
}

function directory_page(){
    drupal_goto("directory/list");
}

function directory_page_sub($type){
    switch($type){
        case 'list':
            return views_embed_view('latest_pages','page_8');
        break;
        case 'map':
            return views_embed_view('latest_pages','page_9');
        break;
    }

    return drupal_not_found();
}

function mc_company_views_query_alter(&$view, &$query) {
    if($view->name != 'latest_pages'){
        return;
    }

    $allowed = array('page_8','page_9');

    if(!in_array($view->current_display,$allowed)){
        return;
    }

    $section = arg(2);
    $arg = arg(3);
    $filter = false;

    switch($section){
        case 'industry':
            if($arg > 0){
                $term = taxonomy_get_term($arg);
                $query->add_table('term_node');
                $query->add_where('term','term_node.tid = %d',$arg);
                $title = "Directory: By Industry: " . $term->name;
                $filter = true;
            }
        break;
        case 'size':
            if(!empty($arg)){
                $query->add_table('content_type_company');
                $query->add_where(NULL,"field_company_size_value = '%s'",$arg);
                $title = "Directory: By Size: " . $arg  ." employees";
                $filter = true;
            }
        break;
        case 'tag':
            switch($arg){
                case 'hiring':
                    $query->add_table('content_type_company');
                    $query->add_where(NULL,"field_ishiring_value = %d",1);
                    $title = "Directory: Hiring";
                    $filter = true;
                break;
                case 'funding':
                    $query->add_table('content_type_company');
                    $query->add_where(NULL,"field_islookingfund_value = %d",1);
                    $title = "Directory: Seeking funding";
                    $filter = true;
                break;
            }
        break;
    } //end switch section

    if(!empty($title)){
        $view->display[$view->current_display]->display_options["title"] = "";
        $view->display[$view->current_display]->handler->options["title"] = $title;
    }

    if($section && !$filter){
        //drupal_goto("directory");
    }

}